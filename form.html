<script>
let selectedCode = "+373";

const countries = [
  { name:"–ú–æ–ª–¥–æ–≤–∞", code:"+373", flag:"üá≤üá©" },
  { name:"–†–æ—Å—Å–∏—è", code:"+7", flag:"üá∑üá∫" },
  { name:"–£–∫—Ä–∞–∏–Ω–∞", code:"+380", flag:"üá∫üá¶" },
  { name:"–†—É–º—ã–Ω–∏—è", code:"+40", flag:"üá∑üá¥" },
  { name:"–°–®–ê", code:"+1", flag:"üá∫üá∏" },
  { name:"–ì–µ—Ä–º–∞–Ω–∏—è", code:"+49", flag:"üá©üá™" },
  { name:"–§—Ä–∞–Ω—Ü–∏—è", code:"+33", flag:"üá´üá∑" }
];

const flagSelect=document.getElementById('flagSelect');
const dropdown=document.getElementById('countryDropdown');
flagSelect.addEventListener('click',()=>{
  dropdown.innerHTML='';
  countries.forEach(c=>{
    const div=document.createElement('div');
    div.textContent=`${c.flag} ${c.code}`;
    div.addEventListener('click',()=>{
      flagSelect.textContent=`${c.flag} ${c.code}`;
      selectedCode = c.code;
      dropdown.style.display='none';
    });
    dropdown.appendChild(div);
  });
  dropdown.style.display='block';
});

document.getElementById('chat_id').value=new URLSearchParams(window.location.search).get('chat_id')||'';

/* üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤ –∏–∑ Google Sheets */
fetch("https://opensheet.elk.sh/10CzQHC01UjusQsFYobQ6a54zV0z__XAkxva_Ir3vDVw/Consultant")
  .then(r=>r.json())
  .then(rows=>{
    const select=document.getElementById('consultantSelect');
    rows.forEach(r=>{
      if(r["–§–ò–û"] && r["chat_id"]){
        const opt=document.createElement('option');
        opt.value=r["chat_id"];      // üëà –≤ value —Ç–µ–ø–µ—Ä—å chat_id
        opt.textContent=r["–§–ò–û"];    // üëà –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –§–ò–û
        opt.dataset.fio = r["–§–ò–û"];  // üëà —Å–æ—Ö—Ä–∞–Ω–∏–º –§–ò–û –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ
        select.appendChild(opt);
      }
    });
  })
  .catch(err=>console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–≤:",err));

const roleSel=document.getElementById('role');
const block=document.getElementById('consultantsBlock');
roleSel.addEventListener('change',()=>{
  const consultantSelect=document.getElementById('consultantSelect');
  if(roleSel.value==='client'){
    block.classList.remove('hidden');
    consultantSelect.required = true;
  }else{
    block.classList.add('hidden');
    consultantSelect.required = false;
  }
});

const form=document.getElementById('form');
const msg=document.getElementById('msg');
form.addEventListener('submit',async e=>{
  e.preventDefault();
  if(!document.getElementById('consent').checked){
    msg.textContent='‚òùÔ∏è –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö';
    msg.className='msg error';
    return;
  }
  const consultantSelect = document.getElementById('consultantSelect');
  const selectedOption = consultantSelect.options[consultantSelect.selectedIndex];

  const data={
    fullName:form.fullName.value.trim(),
    phone:selectedCode + form.phone.value.trim(),
    email:form.email.value.trim(),
    birthDate:form.birthDate.value,
    role:roleSel.value,
    consultant_chat_id: selectedOption?.value || null, // üëà –ø–µ—Ä–µ–¥–∞–µ–º chat_id –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞
    consultant_name: selectedOption?.dataset.fio || null, // üëà –ø–µ—Ä–µ–¥–∞–µ–º –§–ò–û –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞
    chat_id: document.getElementById('chat_id').value
  };

  try{
    const res=await fetch('https://hook.eu2.make.com/9h9m39efm8lp2sen3fm6y6rm74rrc73n',{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)
    });
    if(res.ok){
      msg.textContent='‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!';
      msg.className='msg success';form.reset();
    }else{
      msg.textContent='‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏';msg.className='msg error';
    }
  }catch(err){
    msg.textContent='‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏';msg.className='msg error';
  }
});
</script>
